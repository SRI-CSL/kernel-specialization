# Thttpd example
This example is designed to present how to create a version of kernel specialized with respect to a target application and boot it on the slashed kernel.

We specialize the kernel using the following steps:
1) Create a version of libc specialized with respect to the init utilities and the target program(thttpd in this case).
2) Parse the libc to get a specialized system call list.
3) Specialize the kernel with respect to that list.

The following script implements steps (1) and (2). It takes as argument the file to which you want to write the system call Ids generated and the file to which you want to write the corresponding symbol list.

You need to copy in "crt1.o", "libc.a" and "libc.a.bc", generated as a result of building the bitcode of musl-libc using [musllvm](https://github.com/SRI-CSL/musllvm).
```
./generate_specialized_syscall_list.sh specialize_libc.manifest {filename-for-syscall-Ids} {filename-for-syscall-symbols}
```
The symbols file that you provide as third argument for the command above can now be used as argument to the [kernel slashing script](../../kernel-slashing/slash_kernel.sh) to implement step (3).


## Step-by-Step

#### Generating thttpd bitcode

Start off by downloading and unpacking the thttpd source code.

```
wget http://acme.com/software/thttpd/thttpd-2.27.tar.gz
tar xvf thttpd-2.27.tar.gz
cd thttpd-2.27
```

Next, we are going to build thttpd binary and use the SRI tool, "gllvm", to generate its bitcode. 

```
CC=gclang ./configure 
make CC=gclang
get-bc -b thttpd
```

Now copy the "thttpd.bc" file generated by the above to examples directory.

```
cp thttpd.bc ..
cd ..
```

#### Generating a version of libc specialized to support thttpd and init utilities

To generate a specialized kernel that has just enough functionality to run thttpd, we will need a version of libc that is specialized with respect to thttpd and the init-utilities(having of which is necessary for the proper functioning of the kernel).

Therefore, we are going to use OCCAM to specialize the libc with respect to thttpd and the init utilities. We are going to use [specialize_libc.manifest](specialize_libc.manifest) as the manifest file. The symbols in the [keep.list](keep.list) need to be kept external to provide an entry point into the program.


```
cp ../init-utilities/* .
OCCAM_LOGFILE=occam.log slash --work-dir=slashing --keep-external=keep.list --no-strip specialize_libc.manifest
cp slashing/libc.a-final.bc .
```

#### Parsing the libc to get the system call symbol list

The [ParseSyscalls LLVM pass](../../LLVMPasses/ParseSyscalls) can be used to parse the libc to get the list of IDs of system calls being made. First we will need to build the shared object file for this pass .

```
cd ../../LLVMPasses/ && make build_ParseSyscalls && cd ../examples/thttpd/
```

Next, we need to run this pass with "libc.a-final.bc". It takes the "output-file-name" as input.

```
opt -load ../../LLVMPasses/build/ParseSyscalls.so -asm-analyze -output-file-name=syscall_id_list libc.a-final.bc -o tmp.bc 
```

The syscall_id_list file now contains the list of system call IDs being made inside the libc. However, OCCAM fails to fold one "syscall" asm inline callsite in "libc.a-final.bc" and, therefore, we need to add the system call ID for this case manually. 

```
echo "105" >> syscall_id_list
```

Finally, we can map the system call IDs to kernel symbols by using the script [generateSysCallList.py](../generateSysCallList.py). This generates a list of two kernel symbols per system call and takes as input the "syscall_id_list", a [mapping](../syscallIdToName) from system call ID to system call name and the file name to which the system call symbols should be added.

```
python ../generateSysCallList.py syscall_id_list ../syscallIdToName syscall_symbol_list
```

And we are done. Now, once we update the "syscall_symbol_list" with the list of [necessary_symbols](../necessary_symbols), 

```
cat ../necessary_symbols >> syscall_symbol_list
```
we can use this list as input to ["slash_kernel.sh"](../../kernel-slashing/slash_kernel.sh) to generate a version of the kernel specialized to host "thttpd".

